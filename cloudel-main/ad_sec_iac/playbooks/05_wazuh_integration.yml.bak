---
- name: Configure Wazuh Integration and Active Response
  hosts: localhost
  gather_facts: no
  become: yes
  become_method: sudo
  
  vars:
    # Toggle active responses on/off
    # Set to 'yes' for Protected Mode, 'no' for Vulnerable Mode demonstrations
    enable_active_response: "{{ 'yes' if deployment_mode == 'protected' else 'no' }}"
    wazuh_path: "/var/ossec"
    ansible_become_pass: "{{ lookup('env', 'ANSIBLE_BECOME_PASS') | default(omit) }}"

  tasks:
    - name: Display Wazuh configuration mode
      ansible.builtin.debug:
        msg: 
          - "Configuring Wazuh for {{ deployment_mode }} mode"
          - "Active Response: {{ enable_active_response }}"

    # ===========================================
    # INSTALL DEPENDENCIES
    # ===========================================

    - name: Install jq for JSON parsing
      ansible.builtin.package:
        name: jq
        state: present
      ignore_errors: yes

    # ===========================================
    # DEPLOY CUSTOM RULES
    # ===========================================

    - name: Copy custom detection rules to Wazuh
      ansible.builtin.copy:
        src: ../files/wazuh_rules/local_rules.xml
        dest: "{{ wazuh_path }}/etc/rules/local_rules.xml"
        owner: root
        group: wazuh
        mode: '0640'
      notify: restart wazuh-manager

    # ===========================================
    # DEPLOY ACTIVE RESPONSE SCRIPT
    # ===========================================

    - name: Copy active response script
      ansible.builtin.copy:
        src: ../files/scripts/remediate-threat.sh
        dest: "{{ wazuh_path }}/active-response/bin/remediate-threat.sh"
        owner: root
        group: wazuh
        mode: '0750'

    # ===========================================
    # CONFIGURE ACTIVE RESPONSE IN OSSEC.CONF
    # ===========================================

    - name: Check if active-response block exists
      ansible.builtin.shell: |
        grep -q "<active-response>" {{ wazuh_path }}/etc/ossec.conf
      register: ar_exists
      ignore_errors: yes
      changed_when: false

    - name: Backup ossec.conf
      ansible.builtin.copy:
        src: "{{ wazuh_path }}/etc/ossec.conf"
        dest: "{{ wazuh_path }}/etc/ossec.conf.backup.{{ ansible_date_time.epoch }}"
        remote_src: yes

    - name: Configure Active Response - Mimikatz (HIGH PRIORITY)
      ansible.builtin.blockinfile:
        path: "{{ wazuh_path }}/etc/ossec.conf"
        marker: "<!-- {mark} ANSIBLE MANAGED - Active Response Mimikatz -->"
        insertbefore: "</ossec_config>"
        block: |
          <active-response>
            <disabled>{{ enable_active_response == 'no' }}</disabled>
            <command>remediate-threat</command>
            <location>local</location>
            <rules_id>100010,100011</rules_id>
            <timeout>no</timeout>
          </active-response>

    - name: Configure Active Response - LSASS Access
      ansible.builtin.blockinfile:
        path: "{{ wazuh_path }}/etc/ossec.conf"
        marker: "<!-- {mark} ANSIBLE MANAGED - Active Response LSASS -->"
        insertbefore: "</ossec_config>"
        block: |
          <active-response>
            <disabled>{{ enable_active_response == 'no' }}</disabled>
            <command>remediate-threat</command>
            <location>local</location>
            <rules_id>100020</rules_id>
            <timeout>no</timeout>
          </active-response>

    - name: Configure Active Response - Kerberoasting
      ansible.builtin.blockinfile:
        path: "{{ wazuh_path }}/etc/ossec.conf"
        marker: "<!-- {mark} ANSIBLE MANAGED - Active Response Kerberoasting -->"
        insertbefore: "</ossec_config>"
        block: |
          <active-response>
            <disabled>{{ enable_active_response == 'no' }}</disabled>
            <command>remediate-threat</command>
            <location>local</location>
            <rules_id>100040,100041</rules_id>
            <timeout>no</timeout>
          </active-response>

    - name: Configure Active Response - BloodHound
      ansible.builtin.blockinfile:
        path: "{{ wazuh_path }}/etc/ossec.conf"
        marker: "<!-- {mark} ANSIBLE MANAGED - Active Response BloodHound -->"
        insertbefore: "</ossec_config>"
        block: |
          <active-response>
            <disabled>{{ enable_active_response == 'no' }}</disabled>
            <command>remediate-threat</command>
            <location>local</location>
            <rules_id>100050,100051</rules_id>
            <timeout>no</timeout>
          </active-response>

    - name: Configure Active Response - Honeypot (CRITICAL)
      ansible.builtin.blockinfile:
        path: "{{ wazuh_path }}/etc/ossec.conf"
        marker: "<!-- {mark} ANSIBLE MANAGED - Active Response Honeypot -->"
        insertbefore: "</ossec_config>"
        block: |
          <active-response>
            <disabled>{{ enable_active_response == 'no' }}</disabled>
            <command>remediate-threat</command>
            <location>local</location>
            <rules_id>100080,100081</rules_id>
            <timeout>no</timeout>
          </active-response>

    - name: Configure Active Response - Pass-the-Hash
      ansible.builtin.blockinfile:
        path: "{{ wazuh_path }}/etc/ossec.conf"
        marker: "<!-- {mark} ANSIBLE MANAGED - Active Response PTH -->"
        insertbefore: "</ossec_config>"
        block: |
          <active-response>
            <disabled>{{ enable_active_response == 'no' }}</disabled>
            <command>remediate-threat</command>
            <location>local</location>
            <rules_id>100110</rules_id>
            <timeout>no</timeout>
          </active-response>

    # ===========================================
    # DEFINE COMMAND IN OSSEC.CONF
    # ===========================================

    - name: Define remediate-threat command
      ansible.builtin.blockinfile:
        path: "{{ wazuh_path }}/etc/ossec.conf"
        marker: "<!-- {mark} ANSIBLE MANAGED - Command Definition -->"
        insertafter: "<command>"
        block: |
          <command>
            <name>remediate-threat</name>
            <executable>remediate-threat.sh</executable>
            <timeout_allowed>no</timeout_allowed>
          </command>

    # ===========================================
    # CONFIGURE SYSMON LOG COLLECTION
    # ===========================================

    - name: Configure Sysmon log collection
      ansible.builtin.blockinfile:
        path: "{{ wazuh_path }}/etc/ossec.conf"
        marker: "<!-- {mark} ANSIBLE MANAGED - Sysmon Logs -->"
        insertafter: "<localfile>"
        block: |
          <localfile>
            <location>Microsoft-Windows-Sysmon/Operational</location>
            <log_format>eventchannel</log_format>
          </localfile>

    # ===========================================
    # CONFIGURE POWERSHELL LOG COLLECTION
    # ===========================================

    - name: Configure PowerShell log collection
      ansible.builtin.blockinfile:
        path: "{{ wazuh_path }}/etc/ossec.conf"
        marker: "<!-- {mark} ANSIBLE MANAGED - PowerShell Logs -->"
        insertafter: "<localfile>"
        block: |
          <localfile>
            <location>Microsoft-Windows-PowerShell/Operational</location>
            <log_format>eventchannel</log_format>
          </localfile>
          
          <localfile>
            <location>Windows PowerShell</location>
            <log_format>eventchannel</log_format>
          </localfile>

    # ===========================================
    # CONFIGURE ALERT LEVELS
    # ===========================================

    - name: Set email alert level
      ansible.builtin.lineinfile:
        path: "{{ wazuh_path }}/etc/ossec.conf"
        regexp: '^\s*<email_alert_level>'
        line: '    <email_alert_level>12</email_alert_level>'
        insertafter: '<global>'

    # ===========================================
    # RESTART SERVICES
    # ===========================================

    - name: Restart Wazuh Manager
      ansible.builtin.systemd:
        name: wazuh-manager
        state: restarted
        enabled: yes

    - name: Wait for Wazuh to be ready
      ansible.builtin.wait_for:
        port: 1514
        delay: 5
        timeout: 30

    # ===========================================
    # VERIFY CONFIGURATION
    # ===========================================

    - name: Verify Wazuh Manager is running
      ansible.builtin.systemd:
        name: wazuh-manager
        state: started
      register: wazuh_status

    - name: Check active response configuration
      ansible.builtin.shell: |
        {{ wazuh_path }}/bin/wazuh-logtest -t < /dev/null 2>&1 | grep -i "active" || echo "No errors"
      register: logtest_result
      changed_when: false

    - name: Count custom rules loaded
      ansible.builtin.shell: |
        grep -c "rule id=" {{ wazuh_path }}/etc/rules/local_rules.xml || echo "0"
      register: rules_count
      changed_when: false

    - name: Display configuration summary
      ansible.builtin.debug:
        msg:
          - "Wazuh configuration completed for {{ deployment_mode }} mode"
          - "Active Response Status: {{ 'ENABLED' if enable_active_response == 'yes' else 'DISABLED' }}"
          - "Custom Rules Loaded: {{ rules_count.stdout }}"
          - "Wazuh Manager Status: {{ wazuh_status.status.ActiveState }}"
          - "Config file backed up with timestamp"

  handlers:
    - name: restart wazuh-manager
      ansible.builtin.systemd:
        name: wazuh-manager
        state: restarted